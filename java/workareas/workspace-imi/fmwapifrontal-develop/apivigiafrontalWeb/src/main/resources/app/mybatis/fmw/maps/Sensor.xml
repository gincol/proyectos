<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="es.bcn.imi.framework.vigia.frontal.inventary.orm.dao.SensorDao">
   
    <select id="getSensorsContract" resultType="es.bcn.vigia.fmw.libcommons.integration.orm.model.Sensor">
        SELECT 
        	CODI AS code 
        FROM 
        	TB_SENSOR
		WHERE 
			CODI_CONTRACTA = UPPER(#{codeContract})
		AND
		 	DATA_INICI <![CDATA[<=]]> SYSDATE AND (DATA_FI  <![CDATA[>=]]> SYSDATE OR DATA_FI IS NULL)			
    </select>
    
    <select id="getSensorsByCodes" parameterType="java.util.Map" resultType="es.bcn.vigia.fmw.libcommons.integration.orm.model.Sensor">
		SELECT 	
		 	 CODI AS code,
		 	 TIPUS AS codeType
		FROM 
        	TB_SENSOR
		WHERE
			DATA_INICI <![CDATA[<=]]> SYSDATE AND (DATA_FI  <![CDATA[>=]]> SYSDATE OR DATA_FI IS NULL)
			AND CODI IN	
			<foreach collection="codeSensors" item="codeSensor" open="(" separator="," close=")">
				#{codeSensor}
			</foreach>		
		
	</select>
	
	<select id="getSensorsByParams" parameterType="java.util.Map" resultType="es.bcn.vigia.fmw.libcommons.integration.orm.model.Sensor">
        SELECT 
        	CODI AS code 
        FROM 
        	TB_SENSOR
		WHERE 
		 	DATA_INICI <![CDATA[<=]]> SYSDATE AND (DATA_FI  <![CDATA[>=]]> SYSDATE OR DATA_FI IS NULL)
		 <if test="codeContract != null">
        	AND
        		CODI_CONTRACTA = #{codeContract}
        </if>
        <if test="code != null">	     
			AND
            	CODI = #{code}
        </if>	
        <if test="checkStatusDelete != null">
			AND DATE_DELETE IS NULL
		</if>
    </select>
    
    <select id="getSensorByCodeSensorCodeMCF" parameterType="java.util.Map" resultType="es.bcn.vigia.fmw.libcommons.integration.orm.model.Sensor">
       	SELECT
       		SENSOR.CODI as code,
			SENSOR.TIPUS as codeType,
			SENSOR.DATA_INICI as dateStart,
			SENSOR.DATA_FI as dateEnd
       	FROM TB_SENSOR SENSOR
		JOIN TB_SENSOR_MCF MCF ON(MCF.SENSOR_ID = SENSOR.SENSOR_ID)
		WHERE
		MCF.MCF_ID IN (
			SELECT MCF_ID
			FROM TB_MCF
			WHERE
				CODE_CONTRACT = #{codeContract}
				<if test="codeMCF != null">
				AND CODE = #{codeMCF}
				</if>
				AND	DATE_START <![CDATA[<=]]> SYSDATE AND (DATE_END IS NULL OR DATE_END <![CDATA[>=]]> SYSDATE)
			
		)
		AND	DATA_INICI <![CDATA[<=]]> SYSDATE AND (DATA_FI IS NULL OR DATA_FI <![CDATA[>=]]> SYSDATE)
		AND DATE_DELETE IS NULL
		AND SENSOR.CODI = #{code}
    </select>

	<select id="getSensorByCodeSensorCodeRRMM" parameterType="java.util.Map" resultType="es.bcn.vigia.fmw.libcommons.integration.orm.model.Sensor">
       	SELECT
       		SENSOR.CODI as code,
			SENSOR.TIPUS as codeType,
			SENSOR.DATA_INICI as dateStart,
			SENSOR.DATA_FI as dateEnd
       	FROM TB_SENSOR SENSOR
		JOIN TB_SENSOR_RRMM RRMM ON(RRMM.SENSOR_ID = SENSOR.SENSOR_ID)
		WHERE
		RRMM.RRMM_ID IN (
			SELECT RRMM_ID
			FROM TB_RRMM
			WHERE
				CODE_CONTRACT = #{codeContract}
				<if test="codeRRMM != null">
				AND CODE = #{codeRRMM}
				</if>
				AND	DATE_START <![CDATA[<=]]> SYSDATE AND (DATE_END IS NULL OR DATE_END <![CDATA[>=]]> SYSDATE)
		)
			AND	DATA_INICI <![CDATA[<=]]> SYSDATE AND (DATA_FI IS NULL OR DATA_FI <![CDATA[>=]]> SYSDATE)
			AND DATE_DELETE IS NULL
			AND SENSOR.CODI = #{code}
    </select>
    
</mapper>