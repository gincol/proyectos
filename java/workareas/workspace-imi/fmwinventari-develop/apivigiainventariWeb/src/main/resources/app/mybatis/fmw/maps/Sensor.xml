<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="es.bcn.imi.framework.vigia.inventari.integration.orm.dao.SensorDao">

	<insert id="insert" parameterType="es.bcn.vigia.fmw.libcommons.integration.orm.model.Sensor">
		INSERT INTO TB_SENSOR (
			SENSOR_ID,
			CODI,
			CODI_CONTRACTA,
			TIPUS,
			SERIE_FABRICACIO,
			MARCA,
			MODEL,
			TIPUS_DADES,
			DATA_INICI,
			DATE_INSERT,
			USER_INSERT
		) VALUES (
			SEQ_SENSOR.NEXTVAL,
			#{code},
			#{codeContract},
			#{codeType},
			#{manufacturerSerialNumber},
			#{codeBrand},
			#{codeModel},
			#{dataType},
			SYSTIMESTAMP,
			SYSTIMESTAMP,
			<choose>
				<when test="userUpdate != null">
					#{userUpdate}
				</when>
				<when test="userDelete != null">
					#{userDelete}
				</when>
				<otherwise>
					#{userInsert}
				</otherwise>
			</choose>
		)
	</insert>
	
		
	
	<update id="update" parameterType="es.bcn.vigia.fmw.libcommons.integration.orm.model.Sensor">
		UPDATE
			TB_SENSOR
		SET
			DATA_FI = SYSTIMESTAMP,
			DATE_UPDATE = SYSTIMESTAMP,
			USER_UPDATE = #{userUpdate}
		WHERE
			CODI = #{code}
			AND
			DATA_FI IS NULL
	</update>
	<update id="delete" parameterType="es.bcn.vigia.fmw.libcommons.integration.orm.model.Sensor">
		UPDATE
			TB_SENSOR
		SET
			DATE_DELETE = SYSTIMESTAMP,
			USER_DELETE = #{userDelete}
		WHERE
			CODI = #{code}
			AND
			DATA_FI IS NULL
	</update>
	<select id="selectByMCF" parameterType="java.util.Map" resultType="es.bcn.vigia.fmw.libcommons.integration.orm.model.Sensor">
       	SELECT
       		SENSOR.CODI as code,
			SENSOR.TIPUS as codeType,
			SENSOR.DATA_INICI as dateStart,
			SENSOR.DATA_FI as dateEnd
       	FROM TB_SENSOR SENSOR
		JOIN TB_SENSOR_MCF MCF ON(MCF.SENSOR_ID = SENSOR.SENSOR_ID)
		WHERE
		MCF.MCF_ID = (
			SELECT MCF_ID
			FROM TB_MCF
			WHERE
				CODE_CONTRACT = #{codeContract}
				AND CODE = #{code}
			<if test="dateReference == null">
				AND	DATE_START <![CDATA[<=]]> SYSDATE AND (DATE_END IS NULL OR DATE_END <![CDATA[>=]]> SYSDATE)
			</if>			
			<if test="dateReference != null">
				AND DATE_START <![CDATA[<=]]> TO_TIMESTAMP(#{dateReference}, 'DD-MM-YYYY HH24:MI:SS') AND (DATE_END IS NULL OR DATE_END <![CDATA[>=]]> TO_TIMESTAMP(#{dateReference}, 'DD-MM-YYYY HH24:MI:SS'))
			</if>
		)
		<if test="dateReference == null">
			AND	DATA_INICI <![CDATA[<=]]> SYSDATE AND (DATA_FI IS NULL OR DATA_FI <![CDATA[>=]]> SYSDATE)
		</if>			
		<if test="dateReference != null">
			AND DATA_INICI <![CDATA[<=]]> TO_TIMESTAMP(#{dateReference}, 'DD-MM-YYYY HH24:MI:SS') AND (DATA_FI IS NULL OR DATA_FI <![CDATA[>=]]> TO_TIMESTAMP(#{dateReference}, 'DD-MM-YYYY HH24:MI:SS'))
		</if>
    </select>
	<select id="selectByRRMM" parameterType="java.util.Map" resultType="es.bcn.vigia.fmw.libcommons.integration.orm.model.Sensor">
       	SELECT
       		SENSOR.CODI as code,
			SENSOR.TIPUS as codeType,
			SENSOR.DATA_INICI as dateStart,
			SENSOR.DATA_FI as dateEnd
       	FROM TB_SENSOR SENSOR
		JOIN TB_SENSOR_RRMM RRMM ON(RRMM.SENSOR_ID = SENSOR.SENSOR_ID)
		WHERE
		RRMM.RRMM_ID = (
			SELECT RRMM_ID
			FROM TB_RRMM
			WHERE
				CODE_CONTRACT = #{codeContract}
				AND CODE = #{code}
			<if test="dateReference == null">
				AND	DATE_START <![CDATA[<=]]> SYSDATE AND (DATE_END IS NULL OR DATE_END <![CDATA[>=]]> SYSDATE)
			</if>			
			<if test="dateReference != null">
				AND DATE_START <![CDATA[<=]]> TO_TIMESTAMP(#{dateReference}, 'DD-MM-YYYY HH24:MI:SS') AND (DATE_END IS NULL OR DATE_END <![CDATA[>=]]> TO_TIMESTAMP(#{dateReference}, 'DD-MM-YYYY HH24:MI:SS'))
			</if>
		)
		<if test="dateReference == null">
			AND	DATA_INICI <![CDATA[<=]]> SYSDATE AND (DATA_FI IS NULL OR DATA_FI <![CDATA[>=]]> SYSDATE)
		</if>			
		<if test="dateReference != null">
			AND DATA_INICI <![CDATA[<=]]> TO_TIMESTAMP(#{dateReference}, 'DD-MM-YYYY HH24:MI:SS') AND (DATA_FI IS NULL OR DATA_FI <![CDATA[>=]]> TO_TIMESTAMP(#{dateReference}, 'DD-MM-YYYY HH24:MI:SS'))
		</if>
    </select>
    
    <insert id="insertSensorRRMMM" parameterType="java.util.Map">		
		INSERT INTO TB_SENSOR_RRMM
		SELECT 
		(SELECT RRMM_ID FROM TB_RRMM WHERE CODE_CONTRACT = #{codeContract} AND CODE = #{codeRRMM} AND DATE_END IS NULL) as RRMM_ID,
		SENSOR_ID
		FROM TB_SENSOR
		WHERE
		CODI_CONTRACTA = #{codeContract}
		AND CODI = #{codeSensor}
		AND DATA_FI IS NULL
	</insert>
	
	<insert id="insertSensorMCF" parameterType="java.util.Map">		
		INSERT INTO TB_SENSOR_MCF
		SELECT 
		(SELECT MCF_ID FROM TB_MCF WHERE CODE_CONTRACT = #{codeContract} AND CODE = #{codeMCF} AND DATE_END IS NULL) as MCF_ID,
		SENSOR_ID
		FROM TB_SENSOR
		WHERE
		CODI_CONTRACTA = #{codeContract}
		AND CODI = #{codeSensor}
		AND DATA_FI IS NULL
	</insert>   
	
	
	<select id="getSensorsByParams" parameterType="java.util.Map" resultType="es.bcn.vigia.fmw.libcommons.integration.orm.model.Sensor">
        SELECT 
        	SENSOR.CODI AS code, 
			SENSOR.CODI_CONTRACTA AS codeContract,       
			SENSOR.TIPUS AS codeType,       
			SENSOR.SERIE_FABRICACIO AS manufacturerSerialNumber,  
			SENSOR.MARCA AS codeBrand,  
			SENSOR.MODEL AS codeModel,  
			SENSOR.DATA_INICI AS dateStart,  
			SENSOR.DATA_FI AS dateEnd,  
			SENSOR.DATE_INSERT AS dateInsert,
			SENSOR.USER_INSERT AS userInsert,  
			SENSOR.DATE_UPDATE AS dateUpdate,  
			SENSOR.USER_UPDATE AS userUpdate,  
			SENSOR.DATE_DELETE AS dateDelete,  
			SENSOR.USER_DELETE AS userDelete,  
			SENSOR.TIPUS_DADES AS dataType,
			MCF.CODE AS codeMCF,
            RRMM.CODE AS codeRRMM
	    FROM 
        	TB_SENSOR SENSOR
        	LEFT JOIN TB_SENSOR_MCF SENSOR_MCF ON(SENSOR_MCF.SENSOR_ID = SENSOR.SENSOR_ID)
			LEFT JOIN TB_MCF MCF ON (MCF.MCF_ID = SENSOR_MCF.MCF_ID)
        	LEFT JOIN TB_SENSOR_RRMM SENSOR_RRMM ON(SENSOR_RRMM.SENSOR_ID = SENSOR.SENSOR_ID)
			LEFT JOIN TB_RRMM RRMM ON (RRMM.RRMM_ID = SENSOR_RRMM.RRMM_ID)
        
		WHERE 
			SENSOR.DATE_DELETE IS NULL
			<if test="code != null">	     
				AND	SENSOR.CODI = #{code}
        	</if>	
        	<if test="dateReference == null">
				AND	SENSOR.DATA_INICI <![CDATA[<=]]> SYSDATE AND (SENSOR.DATA_FI IS NULL OR SENSOR.DATA_FI <![CDATA[>=]]> SYSDATE)
			</if>			
			<if test="dateReference != null">
				AND SENSOR.DATA_INICI <![CDATA[<=]]> TO_TIMESTAMP(#{dateReference}, 'DD-MM-YYYY HH24:MI:SS') AND (SENSOR.DATA_FI IS NULL OR SENSOR.DATA_FI <![CDATA[>=]]> TO_TIMESTAMP(#{dateReference}, 'DD-MM-YYYY HH24:MI:SS'))
			</if>
		 	<if test="codeContract != null">
        	AND SENSOR.CODI_CONTRACTA = #{codeContract}
        </if>
        
    </select>
	
</mapper>