<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="es.bcn.imi.framework.vigia.inventari.integration.orm.dao.gap.UbicationGapDao">
   
    <select id="selectUbicationMassive" parameterType="java.util.Map" resultType="es.bcn.vigia.fmw.libcommons.integration.orm.model.gap.UbicationGap">
    	SELECT
			CODI_CONTRACTA as codeContract,
	      	CODI AS code, 
			DATA_INICI as dateStart,
			DATA_FI as dateEnd
		FROM 
			VW_MASIVA_UBICACIO
		WHERE 
			CODI_CONTRACTA = #{codeContract}
			<if test="dateReference == null">
				AND	DATA_INICI <![CDATA[<=]]> SYSDATE AND (DATA_FI IS NULL OR DATA_FI <![CDATA[>=]]> SYSDATE)
			</if>			
			<if test="dateReference != null">
				AND DATA_INICI <![CDATA[<=]]> TO_TIMESTAMP(#{dateReference}, 'DD-MM-YYYY HH24:MI:SS') AND (DATA_FI IS NULL OR DATA_FI <![CDATA[>=]]> TO_TIMESTAMP(#{dateReference}, 'DD-MM-YYYY HH24:MI:SS'))
			</if>
    </select>
   
    <select id="selectUbication" parameterType="java.util.Map" resultType="es.bcn.vigia.fmw.libcommons.integration.orm.model.gap.UbicationGap">
    	SELECT
			CODI_CONTRACTISTA as codeContract,
			CODI as code,
			CODI_TIPUS_UBICACIO as type,
			CODI_ESTAT as state,
			DATA_INICI as dateStart,
			DATA_FI as dateEnd,
			CODI_ZONA as codeZone,
			CODI_TERRITORI as district,
			CODI_BARRI as codeNeighborhood,
			TIPUS_VIA as codeTypeRoad,
			CARRER as streetName,
			CODI_CARRER as streetCode,
			NUMERO_INICI as startNumber,
			NUMERO_FI as endNumber,
			LLETRA_INICI as startLetter,
			LLETRA_FI as endLetter,
			COORDINADA_X as coordinateX,
			COORDINADA_Y as coordinateY,
			ETIQUETA as label,
			POBLACIO as city
		FROM 
			VW_UBICACIO
		WHERE 
			CODI_CONTRACTISTA = #{codeContract}
			<if test="code != null">				
		    	AND CODI = #{code}	
			</if>
			<if test="dateReference == null">
				AND	DATA_INICI <![CDATA[<=]]> SYSDATE AND (DATA_FI IS NULL OR DATA_FI <![CDATA[>=]]> SYSDATE)
			</if>			
			<if test="dateReference != null">
				AND DATA_INICI <![CDATA[<=]]> TO_TIMESTAMP(#{dateReference}, 'DD-MM-YYYY HH24:MI:SS') AND (DATA_FI IS NULL OR DATA_FI <![CDATA[>=]]> TO_TIMESTAMP(#{dateReference}, 'DD-MM-YYYY HH24:MI:SS'))
			</if>
    </select>
   
    <select id="selectMclByUbication" parameterType="java.util.Map" resultType="es.bcn.vigia.fmw.libcommons.integration.orm.model.gap.MclGap">
    	SELECT
			MCL.CONTRACTISTA_CODI as codeContract,
			MCL.CODI as code,
			MCL.DATA_INICI as dateStart,
			MCL.DATA_FI as dateEnd,
			MCF.CODI as codeMCF,
			MCF.DATA_INICI as dateStartMCF,
			MCF.DATA_FI as dateEndMCF
		FROM 
			VW_MOBILIARI_LOGIC MCL
		LEFT JOIN
			VW_MOBILIARI_FISIC MCF ON (MCF.CODI = MCL.MOBFISIC_CODI AND MCF.MCL = MCL.CODI)
		WHERE 
			CONTRACTISTA_CODI = #{codeContract}
			<if test="code != null">				
		    	AND MCL.UBICACIO_CODI = #{code}	
			</if>
			<if test="dateReference == null">
				AND	MCL.DATA_INICI <![CDATA[<=]]> SYSDATE AND (MCL.DATA_FI IS NULL OR MCL.DATA_FI <![CDATA[>=]]> SYSDATE)
			</if>			
			<if test="dateReference != null">
				AND MCL.DATA_INICI <![CDATA[<=]]> TO_TIMESTAMP(#{dateReference}, 'DD-MM-YYYY HH24:MI:SS') AND (MCL.DATA_FI IS NULL OR MCL.DATA_FI <![CDATA[>=]]> TO_TIMESTAMP(#{dateReference}, 'DD-MM-YYYY HH24:MI:SS'))
			</if>
    </select>
</mapper>