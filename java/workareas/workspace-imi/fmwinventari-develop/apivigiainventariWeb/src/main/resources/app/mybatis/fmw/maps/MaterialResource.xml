<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="es.bcn.imi.framework.vigia.inventari.integration.orm.dao.MaterialResourceDao">
	
	<insert id="insert" parameterType="es.bcn.vigia.fmw.libcommons.integration.orm.model.MaterialResource">
		INSERT INTO TB_RRMM (
			RRMM_ID,
			CODE,
			CODE_CONTRACT,
			CODE_TYPE,
			CODE_STATE,
			CODE_INSTALLATION,
			RFID,
			AMORTIZATION_SUBJECT,
			CODE_TYPE_TITULARITY,
			REASON_CHANGE,
			DESCRIPTION,
			DATE_START,
			DATE_INSERT,
			USER_INSERT
		) VALUES (
			SEQ_RRMM.NEXTVAL,
			#{code},
			#{codeContract},
			#{codeType},
			#{codeState},
			#{codeInstallation},
			#{rfid},
			#{amortizationSubject},
			#{codeTypeTitularity},
			#{reasonChange},
			#{description},
			SYSTIMESTAMP,
			SYSTIMESTAMP,
			<choose>
				<when test="userUpdate != null">
					#{userUpdate}
				</when>
				<otherwise>
					#{userInsert}
				</otherwise>
			</choose>
		)
	</insert>
	
	<insert id="insertSensors" parameterType="es.bcn.vigia.fmw.libcommons.integration.orm.model.MaterialResource">		
		INSERT INTO TB_SENSOR_RRMM
		SELECT 
		(SELECT RRMM_ID FROM TB_RRMM WHERE CODE_CONTRACT = #{codeContract} AND CODE = #{code} AND DATE_END IS NULL) as RRMM_ID,
		SENSOR_ID
		FROM TB_SENSOR
		WHERE
		CODI_CONTRACTA = #{codeContract}
		AND CODI IN
		<foreach collection="sensors" item="sensor" open="(" separator="," close=")">
			#{sensor.code}
		</foreach>
		AND DATA_FI IS NULL
	</insert>
	
	<update id="update" parameterType="es.bcn.vigia.fmw.libcommons.integration.orm.model.MaterialResource">
		UPDATE
			TB_RRMM
		SET
			DATE_END = SYSTIMESTAMP,
			DATE_UPDATE = SYSTIMESTAMP,
			USER_UPDATE = #{userUpdate}
		WHERE
			CODE_CONTRACT = #{codeContract}
			AND CODE = #{code} 	
			AND DATE_END IS NULL		
	</update>
	
	<update id="delete" parameterType="es.bcn.vigia.fmw.libcommons.integration.orm.model.MaterialResource">
		UPDATE
			TB_RRMM
		SET
			DATE_END = SYSTIMESTAMP,
			DATE_DELETE = SYSTIMESTAMP,
			USER_DELETE = #{userDelete}
		WHERE
			CODE_CONTRACT = #{codeContract}
			AND CODE = #{code}  	
			AND DATE_END IS NULL		 			
	</update> 
	
	<select id="selectMaterialResource" resultType="es.bcn.vigia.fmw.libcommons.integration.orm.model.MaterialResource">
		SELECT
			CODE as code,
			CODE_CONTRACT as codeContract,
			CODE_TYPE as codeType,
			CODE_STATE as codeState,
			CODE_INSTALLATION as codeInstallation,
			RFID as rfid,
			AMORTIZATION_SUBJECT as amortizationSubject,
			CODE_TYPE_TITULARITY as codeTypeTitularity,
			REASON_CHANGE as reasonChange,
			DESCRIPTION as description,
			DATE_START as dateStart,
			DATE_END as dateEnd,
			DATE_INSERT as dateInsert,
			DATE_UPDATE as dateUpdate,
			DATE_DELETE as dateDelete,
			USER_INSERT as userInsert,
			USER_UPDATE as userUpdate,
			USER_DELETE as userDelete
		FROM
			TB_RRMM
		WHERE
			CODE_CONTRACT = #{codeContract}
			<if test="code != null">
				AND CODE = #{code}
			</if>
			<if test="dateReference == null">
				AND	DATE_START <![CDATA[<=]]> SYSDATE AND (DATE_END IS NULL OR DATE_END <![CDATA[>=]]> SYSDATE)
			</if>			
			<if test="dateReference != null">
				AND DATE_START <![CDATA[<=]]> TO_TIMESTAMP(#{dateReference}, 'DD-MM-YYYY HH24:MI:SS') AND (DATE_END IS NULL OR DATE_END <![CDATA[>=]]> TO_TIMESTAMP(#{dateReference}, 'DD-MM-YYYY HH24:MI:SS'))
			</if>
    </select>   
	
	<select id="selectMaterialResourceVehicle" parameterType="java.util.Map" resultType="es.bcn.vigia.fmw.libcommons.integration.orm.model.MaterialResourceVehicles">
		SELECT
			CODE as code,
			CODE_CONTRACT as codeContract,
			EURO_STANDARD as euroStandard,
			TYPE_EMISSIONS as typeEmissions,
			LOADING_TECHNOLOGY as loadingTechnology,
			DATE_INSERT as dateInsert,
			DATE_UPDATE as dateUpdate,
			DATE_DELETE as dateDelete,
			USER_INSERT as userInsert,
			USER_UPDATE as userUpdate,
			USER_DELETE as userDelete
		FROM
			TB_RRMM_VEHICLE
		WHERE
			CODE_CONTRACT = #{codeContract}
			<if test="code != null">
				AND CODE = #{code}
			</if>			
			<if test="dateReference == null">
				AND	DATE_START <![CDATA[<=]]> SYSDATE AND (DATE_END IS NULL OR DATE_END <![CDATA[>=]]> SYSDATE)
			</if>			
			<if test="dateReference != null">
				AND DATE_START <![CDATA[<=]]> TO_TIMESTAMP(#{dateReference}, 'DD-MM-YYYY HH24:MI:SS') AND (DATE_END IS NULL OR DATE_END <![CDATA[>=]]> TO_TIMESTAMP(#{dateReference}, 'DD-MM-YYYY HH24:MI:SS'))
			</if>
    </select> 

</mapper>