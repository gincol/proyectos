<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="es.bcn.imi.framework.vigia.inventari.integration.orm.dao.DocumentarySupportDao">
    
	<insert id="insert" parameterType="es.bcn.vigia.fmw.libcommons.integration.orm.model.DocumentarySupport">
		INSERT INTO TB_SUPORT_DOCUMENTAL (
			CODI_CONTRACTA,
			CODSUPORTDOCUMENTAL,
			CODDOCUMENTMUNICIPAL,
			DATA_INICI,
			DATE_INSERT,	
			USER_INSERT
		) VALUES (
			#{codeContract},
			#{codeContractDocument},
			#{codeMunicipalDocument},
			SYSTIMESTAMP,
			SYSTIMESTAMP,
			#{userInsert}
		)			
	</insert>
	
	<update id="update" parameterType="es.bcn.vigia.fmw.libcommons.integration.orm.model.DocumentarySupport">
		UPDATE	
			TB_SUPORT_DOCUMENTAL
		SET
			DATA_ANULLACIO = TO_TIMESTAMP(#{dateAnnulment}, 'dd/MM/yyyy HH24:MI:SS'),
			MOTIU_ANULLACIO = #{annulmentReason},
			USER_DELETE = #{userDelete}
		WHERE
			CODI_CONTRACTA = #{codeContract}
		AND
			CODSUPORTDOCUMENTAL = #{codeContractDocument}
	</update>
	
	<insert id="insertDocumentElement" parameterType="es.bcn.vigia.fmw.libcommons.integration.orm.model.DocumentarySupport">
		INSERT INTO TB_DOCUMENT_ELEMENT (
			CODI_CONTRACTA,
			CODSUPORTDOCUMENTAL,
			DATA_CREACIO,
			TIPUS_ELEMENT,
			CODI_ELEMENT,
			CODDOCUMENTMUNICIPAL,
			NOM_DOCUMENT,
			TIPUS_DOCUMENT,
			OBSERVACIONS,
			CODI_ACTUACIO,
			DATA_INICI,
			DATE_INSERT,	
			USER_INSERT
		) VALUES (
			#{codeContract},
			#{codeContractDocument},
			TO_TIMESTAMP(#{dateCreation}, 'dd/MM/yyyy HH24:MI:SS'),
			#{codeTypeEntity},
			#{code},
			#{codeMunicipalDocument},
			#{nameDocument},
			#{typeDocument},
			#{observations},
			#{codeActuation},
			SYSTIMESTAMP,
			SYSTIMESTAMP,
			#{userInsert}
		)
	</insert> 
	
	<select id="selectDocumentElement" parameterType="es.bcn.vigia.fmw.libcommons.integration.orm.model.DocumentarySupport" resultType="es.bcn.vigia.fmw.libcommons.integration.orm.model.DocumentarySupport">
       	SELECT
			CODI_CONTRACTA AS codeContract,
			CODSUPORTDOCUMENTAL AS codeContractDocument,
			TO_CHAR(DATA_CREACIO,'dd/MM/yyyy HH24:MI:SS') AS dateCreation,
			TIPUS_ELEMENT AS codeTypeEntity,
			CODI_ELEMENT AS code,
			CODDOCUMENTMUNICIPAL AS codeMunicipalDocument,
			NOM_DOCUMENT AS nameDocument,
			TIPUS_DOCUMENT AS typeDocument,
			OBSERVACIONS AS observations,
			CODI_ACTUACIO AS codeActuation,
			USER_INSERT AS userInsert
       	FROM 
           	TB_DOCUMENT_ELEMENT
       	WHERE
				
			CODI_CONTRACTA = #{codeContract}
		AND 	
			CODSUPORTDOCUMENTAL = #{codeContractDocument}
		AND 
			CODI_ELEMENT = 	#{code}
		AND 
			DATA_FI IS NULL
    </select>
    
    <update id="deleteDocumentElement" parameterType="es.bcn.vigia.fmw.libcommons.integration.orm.model.DocumentarySupport">
		UPDATE	
			TB_DOCUMENT_ELEMENT
		SET DATA_FI = SYSTIMESTAMP,
			DATE_DELETE = SYSTIMESTAMP,
			USER_DELETE = #{userDelete}  
		 WHERE
				CODI_CONTRACTA = #{codeContract}
			AND 	
				CODSUPORTDOCUMENTAL = #{codeContractDocument}
			AND 
				DATA_FI IS NULL
	</update> 
	
	<select id="selectDocumentarySupport" parameterType="java.util.Map" resultType="es.bcn.vigia.fmw.libcommons.integration.orm.model.DocumentarySupport">
		SELECT
			S.CODI_CONTRACTA as codeContract,			
			D.CODI_ELEMENT as code,
			S.CODSUPORTDOCUMENTAL as codeContractDocument,
			D.DATA_CREACIO as dateCreation,
			D.NOM_DOCUMENT as nameDocument,
			D.TIPUS_DOCUMENT as typeDocument,
			D.OBSERVACIONS as observations,
			D.CODI_ACTUACIO as codeActuation,
			S.DATA_ANULLACIO AS dateAnnulment
		FROM
			TB_SUPORT_DOCUMENTAL S
		JOIN
			TB_DOCUMENT_ELEMENT D ON(D.CODI_CONTRACTA = S.CODI_CONTRACTA AND D.CODSUPORTDOCUMENTAL = S.CODSUPORTDOCUMENTAL)
		WHERE
			S.CODI_CONTRACTA = #{codeContract}
			AND D.CODI_ELEMENT = #{code}
			AND D.TIPUS_ELEMENT = #{codeTypeEntity}
			<if test="considerAnnulments == null">
				AND S.DATA_ANULLACIO IS NULL
			</if>			
	</select>
    
    <insert id="insertDocumentExpense" parameterType="es.bcn.vigia.fmw.libcommons.integration.orm.model.DocumentarySupportExpense">
		INSERT INTO TB_DOCUMENT_DESPESES
			(
				CODI_CONTRACTA,
				CODSUPORTDOCUMENTAL,
				DATA_CREACIO,
				CODI_INSTALACIO,
				CODDOCUMENTMUNICIPAL,
				NOM_DOCUMENT,
				TIPUS_DOCUMENT,
				OBSERVACIONS,
				CONCEPTE, 
				SUBTIPUS_DESPESA,
				VALOR,
				PERIODE,
				DATA_INICI,
				DATE_INSERT,	
				USER_INSERT
			) 
		VALUES(
				#{codeContract},
				#{codeContractDocument},
				TO_TIMESTAMP(#{dateCreation}, 'dd/MM/yyyy HH24:MI:SS'),
				#{code},
				#{codeMunicipalDocument},
				#{nameDocument},
				#{typeDocument},
				#{observations},
				#{concept},
				#{codeSubTypeExpense},
				#{value},
				#{period},
				SYSTIMESTAMP,
				SYSTIMESTAMP,
				#{userInsert})
	</insert>
	
	<update id="deleteDocumentExpense" parameterType="es.bcn.vigia.fmw.libcommons.integration.orm.model.DocumentarySupportExpense">
		UPDATE	
			TB_DOCUMENT_DESPESES
		SET DATA_FI = SYSTIMESTAMP,
			DATE_DELETE = SYSTIMESTAMP,
			USER_DELETE = #{userDelete}  
		 WHERE
				CODI_CONTRACTA = #{codeContract}
			AND 	
				CODSUPORTDOCUMENTAL = #{codeContractDocument}
			AND 
				DATA_FI IS NULL
	</update>
	
	<select id="selectDocumentExpense" parameterType="es.bcn.vigia.fmw.libcommons.integration.orm.model.DocumentarySupport" resultType="es.bcn.vigia.fmw.libcommons.integration.orm.model.DocumentarySupport">
       	SELECT
			CODI_CONTRACTA AS codeContract,
			CODSUPORTDOCUMENTAL AS codeContractDocument,
			TO_CHAR(DATA_CREACIO,'dd/MM/yyyy HH24:MI:SS') AS dateCreation,
			CODI_INSTALACIO AS code,
			CODDOCUMENTMUNICIPAL AS codeMunicipalDocument,
			NOM_DOCUMENT AS nameDocument,
			TIPUS_DOCUMENT AS typeDocument,
			OBSERVACIONS AS observations,
			CODI_ACTUACIO AS codeActuation,
			USER_INSERT AS userInsert
       	FROM 
           	TB_DOCUMENT_DESPESES
       	WHERE
				
			CODI_CONTRACTA = #{codeContract}
		AND 	
			CODSUPORTDOCUMENTAL = #{codeContractDocument}
		AND 
			CODI_INSTALACIO = 	#{code}
		AND 
			DATA_FI IS NULL
    </select>
</mapper>