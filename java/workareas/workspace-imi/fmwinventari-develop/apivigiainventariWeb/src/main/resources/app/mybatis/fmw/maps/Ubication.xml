<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="es.bcn.imi.framework.vigia.inventari.integration.orm.dao.UbicationDao">

	<resultMap id="UbicationResultMap" type="es.bcn.vigia.fmw.libcommons.integration.orm.model.Ubication">
		<id column="ID_CONTRACT" property="id" />
		<result column="CODE" property="code" />
		<result column="REF_TYPE_ENVIRONMENT" property="refTypeEnvironment" />
		<result column="REASON_CHANGE" property="reasonChange" />
		<result column="DATE_INSERT" property="dateInsert" />
		<result column="DATE_UPDATE" property="dateUpdate" />
		<result column="DATE_DELETE" property="dateDelete" />
		<result column="USER_INSERT" property="userInsert" />
		<result column="USER_UPDATE" property="userUpdate" />
		<result column="USER_DELETE" property="userDelete" />
		<result column="COORDINATE_1_X" property="coordinate_1_X" />
		<result column="COORDINATE_1_Y" property="coordinate_1_Y" />
		<result column="COORDINATE_2_X" property="coordinate_2_X" />
		<result column="COORDINATE_2_Y" property="coordinate_2_Y" />
		<result column="COORDINATE_3_X" property="coordinate_3_X" />
		<result column="COORDINATE_3_Y" property="coordinate_3_Y" />
		<result column="COORDINATE_4_X" property="coordinate_4_X" />
		<result column="COORDINATE_4_Y" property="coordinate_4_Y" />
	</resultMap>
	
    
	<insert id="insert" parameterType="es.bcn.vigia.fmw.libcommons.integration.orm.model.Ubication">
		INSERT INTO TB_UBICATION (
			UBICATION_ID,
			CODE,
			CODE_CONTRACT,
			REF_TYPE_ENVIRONMENT,
			REASON_CHANGE,
			DATE_START,
			COORDINATE_1_X,
			COORDINATE_1_Y,
			COORDINATE_2_X,
			COORDINATE_2_Y,
			COORDINATE_3_X,
			COORDINATE_3_Y,
			COORDINATE_4_X,
			COORDINATE_4_Y,
			DATE_INSERT,
			USER_INSERT
		) VALUES (
			SEQ_UBICATION.NEXTVAL,
			#{code},
			#{codeContract},
			#{refTypeEnvironment},
			#{reasonChange},
			SYSTIMESTAMP,
			#{coordinate_1_X},
			#{coordinate_1_Y},
			#{coordinate_2_X},
			#{coordinate_2_Y},
			#{coordinate_3_X},
			#{coordinate_3_Y},
			#{coordinate_4_X},
			#{coordinate_4_Y},
			SYSTIMESTAMP,
			<choose>
				<when test="userUpdate != null">
					#{userUpdate}
				</when>
				<otherwise>
					#{userInsert}
				</otherwise>
			</choose>
		)	
			
	</insert> 
	
	<update id="update" parameterType="es.bcn.vigia.fmw.libcommons.integration.orm.model.Ubication">
		UPDATE
			TB_UBICATION
		SET
			DATE_END = SYSTIMESTAMP,
			DATE_UPDATE = SYSTIMESTAMP,
			USER_UPDATE = #{userUpdate}
		WHERE
			CODE_CONTRACT = #{codeContract}
			AND CODE = #{code}
			AND DATE_END IS NULL	
	</update>
	
	<update id="delete" parameterType="es.bcn.vigia.fmw.libcommons.integration.orm.model.Ubication">
		UPDATE
			TB_UBICATION
		SET
			DATE_END = SYSTIMESTAMP,
			DATE_DELETE = SYSTIMESTAMP,
			USER_DELETE = #{userDelete}
		WHERE
			CODE_CONTRACT = #{codeContract}
			AND CODE = #{code}
			AND DATE_END IS NULL			
	</update>  
	
	<select id="select" resultMap="UbicationResultMap">
       	SELECT
			CODE,
			CODE_CONTRACT,
			REF_TYPE_ENVIRONMENT,
			REASON_CHANGE,
			DATE_INSERT,
			DATE_UPDATE,
			DATE_DELETE,
			USER_INSERT,
			USER_UPDATE,
			USER_DELETE,
			COORDINATE_1_X,
			COORDINATE_1_Y,
			COORDINATE_2_X,
			COORDINATE_2_Y,
			COORDINATE_3_X,
			COORDINATE_3_Y,
			COORDINATE_4_X,
			COORDINATE_4_Y
       	FROM 
           TB_UBICATION
       	WHERE
			CODE = #{code}
			AND DATE_END IS NULL	
    </select>
	
	<select id="selectUbication"  parameterType="java.util.Map" resultMap="UbicationResultMap">
       	SELECT
			CODE as code,
			CODE_CONTRACT as codeContract,
			REF_TYPE_ENVIRONMENT as refTypeEnvironment,
			REASON_CHANGE as reasonChange,
			COORDINATE_1_X as coordinate_1_X,
			COORDINATE_1_Y as coordinate_1_Y,
			COORDINATE_2_X as coordinate_2_X,
			COORDINATE_2_Y as coordinate_2_Y,
			COORDINATE_3_X as coordinate_3_X,
			COORDINATE_3_Y as coordinate_3_Y,
			COORDINATE_4_X as coordinate_4_X,
			COORDINATE_4_Y as coordinate_4_Y
       	FROM 
           	TB_UBICATION
       	WHERE
			CODE_CONTRACT = #{codeContract}
			AND CODE = #{code}
			<if test="dateReference == null">
				AND	DATE_START <![CDATA[<=]]> SYSDATE AND (DATE_END IS NULL OR DATE_END <![CDATA[>=]]> SYSDATE)
			</if>			
			<if test="dateReference != null">
				AND DATE_START <![CDATA[<=]]> TO_TIMESTAMP(#{dateReference}, 'DD-MM-YYYY HH24:MI:SS') AND (DATE_END IS NULL OR DATE_END <![CDATA[>=]]> TO_TIMESTAMP(#{dateReference}, 'DD-MM-YYYY HH24:MI:SS'))
			</if>
    </select>
</mapper>