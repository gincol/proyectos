<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="es.bcn.imi.framework.vigia.inventari.integration.orm.dao.gap.InstallationGapDao">
   
    <select id="selectInstallation" parameterType="java.util.Map" resultType="es.bcn.vigia.fmw.libcommons.integration.orm.model.gap.InstallationGap">
		SELECT
		    CONTRACTA_CODI as codeContract,
		    CODI as code,
		    DESCRIPCIO as description,
		    CODI_BARRI as codeNeighborhood,
		    CODI_POSTAL as codePostal,
		    CODI_TERRITORI as codeTerritory,
		    CODI_TIPUS_VIA as codeTypeRoad,
		    LLETRA_INICI as startLetter,
		    LLETRA_FI as endLetter,
		    CARRER as streetName,
			CODI_CARRER as streetCode,
		    NUMERO_INICI as startNumber,
		    NUMERO_FI as endNumber,
		    POSICIO_X as coordinateX,
		    POSICIO_Y as coordinateY,
		    SUPERFICIE as surface,
		    TIPUS_CODI as type,
		    TIPUS_TITULARITAT_CODI as codeTypeTitularity,
		    ESTAT_CODI as state,
		    DATA_INICI as dateStart,
		    DATA_FI as dateEnd,
		    RAO_CANVI as reasonChange,
		    SUBJECTE_AMORTITZACIO as amortizationSubject
		FROM 
		    VW_INSTALACIO
		WHERE
			CONTRACTA_CODI = #{codeContract}
			<if test="code != null">				
		    	AND CODI = #{code}	
			</if>
			<if test="dateReference == null and period == null">
				AND	DATA_INICI <![CDATA[<=]]> SYSDATE AND (DATA_FI IS NULL OR DATA_FI <![CDATA[>=]]> SYSDATE)
			</if>			
			<if test="dateReference != null">
				AND DATA_INICI <![CDATA[<=]]> TO_TIMESTAMP(#{dateReference}, 'DD-MM-YYYY HH24:MI:SS') AND (DATA_FI IS NULL OR DATA_FI <![CDATA[>=]]> TO_TIMESTAMP(#{dateReference}, 'DD-MM-YYYY HH24:MI:SS'))
			</if>
			<if test="period != null">
				AND DATA_INICI = (
					SELECT
						MAX(DATA_INICI)
					FROM
						VW_INSTALACIO
					WHERE
						CONTRACTA_CODI = #{codeContract}						
						<if test="code != null">				
					    	AND CODI = #{code}	
						</if>
						AND DATA_INICI <![CDATA[<=]]> TO_TIMESTAMP(#{period}, 'DD-MM-YYYY')
				)			
			</if>
    </select>
    
    <select id="selectApportionmentsByInstallation" parameterType="java.util.Map" resultType="es.bcn.vigia.fmw.libcommons.integration.orm.model.gap.ApportionmentGap">
	    SELECT
			CODI_SERVEI as codeService,
			PERCENTATGE as percentage,
			DATA_INICI as dateStart,
			DATA_FI as dateEnd
		FROM
			VW_PRORRATEIG_INSTALACIO
		WHERE
			CONTRACTA_CODI = #{codeContract}
			AND CODI_INSTALACIO = #{code}
			<if test="dateReference == null and period == null">
				AND	DATA_INICI <![CDATA[<=]]> SYSDATE AND (DATA_FI IS NULL OR DATA_FI <![CDATA[>=]]> SYSDATE)
			</if>			
			<if test="dateReference != null">
				AND DATA_INICI <![CDATA[<=]]> TO_TIMESTAMP(#{dateReference}, 'DD-MM-YYYY HH24:MI:SS') AND (DATA_FI IS NULL OR DATA_FI <![CDATA[>=]]> TO_TIMESTAMP(#{dateReference}, 'DD-MM-YYYY HH24:MI:SS'))
			</if>
			<if test="period != null">
				AND DATA_INICI = (
					SELECT
						MAX(DATA_INICI)
					FROM
						VW_PRORRATEIG_INSTALACIO
					WHERE
						CONTRACTA_CODI = #{codeContract}						
						<if test="code != null">				
					    	AND CODI_INSTALACIO = #{code}	
						</if>
						AND DATA_INICI <![CDATA[<=]]> TO_TIMESTAMP(#{period}, 'DD-MM-YYYY')
				)			
			</if>
    </select>
    
    <select id="selectExpensesByInstallation" parameterType="java.util.Map" resultType="es.bcn.vigia.fmw.libcommons.integration.orm.model.gap.ExpenseGap">
	    SELECT
			IMPORT as amount,
			PERIODE as period,
			CODI_TIPUS_DESPESA as codeType,
			CODI_SUBTIPUS_DESPESA as codeSubType,
			MESOS_PAGATS as monthsPaid,
			CONCEPTE as concept,
			DATA_INICI as dateStart,
			DATA_FI as dateEnd
		FROM
			VW_DESPESES_INST
		WHERE
			CONTRACTA_CODI = #{codeContract}
			AND INST_CODI = #{code}	
			<if test="dateReference == null and period == null">
				AND	DATA_INICI <![CDATA[<=]]> SYSDATE AND (DATA_FI IS NULL OR DATA_FI <![CDATA[>=]]> SYSDATE)
			</if>			
			<if test="dateReference != null">
				AND DATA_INICI <![CDATA[<=]]> TO_DATE(#{dateReference}, 'DD-MM-YYYY HH24:MI:SS') AND (DATA_FI IS NULL OR DATA_FI <![CDATA[>=]]> TO_DATE(#{dateReference}, 'DD-MM-YYYY HH24:MI:SS'))
			</if>
			<if test="period != null">
				AND DATA_INICI = (
					SELECT
						MAX(DATA_INICI)
					FROM
						VW_DESPESES_INST
					WHERE
						CONTRACTA_CODI = #{codeContract}						
						<if test="code != null">				
					    	AND INST_CODI = #{code}	
						</if>
						AND DATA_INICI <![CDATA[<=]]> TO_TIMESTAMP(#{period}, 'DD-MM-YYYY')
				)			
			</if>
    </select>
    
    <select id="selectAmortizationBasesByInstallation" parameterType="java.util.Map" resultType="es.bcn.vigia.fmw.libcommons.integration.orm.model.gap.AmortizationBaseGap">
    	SELECT
			CONCEPTE as concept,
			VALOR as value,
			PERCENT_FINANCAMENT as percentageFunding,
			INTERESSOS as interests,
			VALOR_AMORTITZACIO as valueAmortization,
			MESOS_PAGATS as monthsPaid,
			PERIODE as period,
			DATA_INICI as dataStart,
			DATA_FI as dataEnd
		FROM
			VW_BASE_AMORT_INST
		WHERE
			CONTRACTA_CODI = #{codeContract}
			AND INST_CODI = #{code}
			<if test="dateReference == null and period == null">
				AND	DATA_INICI <![CDATA[<=]]> SYSDATE AND (DATA_FI IS NULL OR DATA_FI <![CDATA[>=]]> SYSDATE)
			</if>			
			<if test="dateReference != null">
				AND DATA_INICI <![CDATA[<=]]> TO_TIMESTAMP(#{dateReference}, 'DD-MM-YYYY HH24:MI:SS') AND (DATA_FI IS NULL OR DATA_FI <![CDATA[>=]]> TO_TIMESTAMP(#{dateReference}, 'DD-MM-YYYY HH24:MI:SS'))
			</if> 
			<if test="period != null">
				AND DATA_INICI = (
					SELECT
						MAX(DATA_INICI)
					FROM
						VW_BASE_AMORT_INST
					WHERE
						CONTRACTA_CODI = #{codeContract}						
						<if test="code != null">				
					    	AND INST_CODI = #{code}	
						</if>
						AND DATA_INICI <![CDATA[<=]]> TO_TIMESTAMP(#{period}, 'DD-MM-YYYY')
				)			
			</if>   
    </select>
    
    <select id="selectDetailCertificationAmortizationByInstallation" parameterType="java.util.Map" resultType="es.bcn.vigia.fmw.libcommons.integration.orm.model.gap.DetailCertificationGap">
    	SELECT
			CONCEPTE as concept,
			MESOS_PAGATS as monthsPaid,
			IMPORT as amountAmortization,
			IMPORT_RESTANT as amountRemaining,
			CODI_TIPUS_AMORTITZACIO as typeAmortization,
			DATA_CERTIFICACIO as dateCertification,
			CODI_GRUP_SERVEI as codeService
		FROM
			VW_AMORT_INVERSIONS_INST
		WHERE
			CONTRACTA_CODI = #{codeContract}
			AND INST_CODI = #{code}			
			<if test="period == null">
				AND	DATA_INICI <![CDATA[<=]]> SYSDATE AND (DATA_FI IS NULL OR DATA_FI <![CDATA[>=]]> SYSDATE)					
			</if>    
			<if test="period != null">
				AND DATA_INICI = (
					SELECT
						MAX(DATA_INICI)
					FROM
						VW_AMORT_INVERSIONS_INST
					WHERE
						CONTRACTA_CODI = #{codeContract}						
						<if test="code != null">				
					    	AND INST_CODI = #{code}	
						</if>
						AND DATA_INICI <![CDATA[<=]]> TO_TIMESTAMP(#{period}, 'DD-MM-YYYY')
				)			
			</if>     
    </select>
    
    <select id="selectDetailCertificationExpensesByInstallation" parameterType="java.util.Map" resultType="es.bcn.vigia.fmw.libcommons.integration.orm.model.gap.DetailCertificationGap">
    	SELECT
			CONCEPTE as concept,
			MESOS_PAGATS as monthsPaid,
			IMPORT as amountAmortization,
			IMPORT_RESTANT as amountRemaining,
			CODI_TIPUS_AMORTITZACIO as typeAmortization,
			DATA_CERTIFICACIO as dateCertification,
			CODI_GRUP_SERVEI as codeService
		FROM
			VW_AMORT_DESP_INST
		WHERE
			CONTRACTA_CODI = #{codeContract}
			AND INST_CODI = #{code}
			<if test="period == null">
				AND	DATA_INICI <![CDATA[<=]]> SYSDATE AND (DATA_FI IS NULL OR DATA_FI <![CDATA[>=]]> SYSDATE)					
			</if>    
			<if test="period != null">
				AND DATA_INICI = (
					SELECT
						MAX(DATA_INICI)
					FROM
						VW_AMORT_DESP_INST
					WHERE
						CONTRACTA_CODI = #{codeContract}						
						<if test="code != null">				
					    	AND INST_CODI = #{code}	
						</if>
						AND DATA_INICI <![CDATA[<=]]> TO_TIMESTAMP(#{period}, 'DD-MM-YYYY')
				)			
			</if>     
    </select>
    
</mapper>
	
	
